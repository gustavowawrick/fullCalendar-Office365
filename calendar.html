<!DOCTYPE html>
<html lang='en'>

<head>
  <meta charset='utf-8' />
  <!-- Biblioteca FullCalendar -->
  <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
  <!-- Biblioteca jQuery -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <!-- Ícones Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
  <!-- Estilo CSS -->
  <link href="style.css" rel="stylesheet">

  <title>Calendário</title>

</head>

<body>

  <div id='calendar'></div>

  <div id="tooltip" class="tooltip"></div>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const calendarEl = document.getElementById('calendar');
      const tooltip = document.getElementById('tooltip');
      let timeoutId; // Variável para armazenar o ID do timeout

      // Método para comparar o tipo de evento
      function compareEventType(event) {
        // Verifica se o tipo do evento é "teams"
        if (event.extendedProps.type === true) {
          return 'iconeTeams.png';
        } else {
          return 'iconeNota.png';
        }
      }

      // Configuração do FullCalendar
      const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        themeSystem: 'bootstrap',
        headerToolbar: {
          left: 'today prev,next',
          center: 'title',
          right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek',
        },
        navLinks: true,
        nowIndicator: true,
        weekNumberCalculation: 'ISO',
        editable: true,
        selectable: true,
        dayMaxEvents: true,
        weekends: false,
        locale: 'pt-br',
        slotMinTime: '06:00',
        slotMaxTime: '23:00',
        allDaySlot: false,
        dayHeaderFormat: {
          weekday: 'long',
          month: 'long',
          day: 'numeric'
        },
        buttonText: {
          today: 'Hoje',
          month: 'Mês',
          week: 'Semana',
          day: 'Dia',
          list: 'Lista'
        },
        weekText: 'Semana',
        allDayText: 'Dia inteiro',
        slotLabelFormat: {
          hour: '2-digit',
          minute: '2-digit',
          omitZeroMinute: false,
          meridiem: 'narrow',
          hour12: false
        },
        dayHeaderFormat: { weekday: 'long' }, // Exibe os nomes dos dias por extenso
        dayPopoverFormat: { weekday: 'long', month: 'long', day: 'numeric', omitCommas: true },
        eventMouseEnter: function (arg) {
          clearTimeout(timeoutId); // Limpa o timeout anterior, se houver
          timeoutId = setTimeout(function () {
            const tooltipContent = getEventTooltip(arg.event);
            tooltip.innerHTML = tooltipContent;
            tooltip.style.display = 'block';
            tooltip.style.top = arg.jsEvent.pageY + 'px';
            tooltip.style.left = arg.jsEvent.pageX + 'px';
          }, 1000);
          $('.fc-title').attr('title', '');
        },
        eventMouseLeave: function () {
          clearTimeout(timeoutId); // Limpa o timeout se o mouse sair antes de 2 segundos
          tooltip.style.display = 'none';
        },
        eventClick: function (info) {
          const event = info.event;
          const modalContent = `
            <div>
              <h2>${event.title}</h2>
              <p><strong>Data de Início:</strong> ${event.start.toLocaleString()}</p>
              <p><strong>Data de Término:</strong> ${event.end.toLocaleString()}</p>
              <p><strong>Descrição:</strong> ${event.extendedProps.description || 'Nenhuma descrição disponível'}</p>
            </div>
          `;
          showModal(modalContent);
        },
        eventContent: function (arg) {
          const viewType = arg.view.type;
          let content = '<div class="fc-content ';
          let truncatedTitle;
          let icon;

          icon = compareEventType(arg.event);

          if (viewType === 'dayGridMonth') {
            truncatedTitle = truncateText(arg.event.title, 30);
            content += 'fc-event-' + (compareEventType(arg.event) ? 'teams' : 'nota');
            content += '">'; // Fecha a declaração da classe
            content += '<div class="fc-bar"></div>';
            content += '<span class="fc-time">' + formatDate(arg.event.start) + '</span>';
            content += '<img src="img/' + icon + '" alt="Ícone">';
            content += '<span class="fc-title" title="' + arg.event.title + '">' + truncatedTitle + '</span>';
          } else if (viewType === 'timeGridWeek' || viewType === 'timeGridDay') {
            truncatedTitle = truncateText(arg.event.title, viewType === 'timeGridWeek' ? 30 : 40);
            content += 'fc-content-week ';
            content += 'fc-event-' + (compareEventType(arg.event) ? 'teams' : 'nota');
            content += '">'; // Fecha a declaração da classe
            content += '<div class="fc-bar"></div>';
            content += '<span class="fc-title-container">';
            content += '<img src="img/' + icon + '" alt="Ícone">';
            content += '<span class="fc-title" title="' + arg.event.title + '">' + truncatedTitle + '</span>';
            content += '</span>';
            content += '</div>';
          } else if (viewType === 'listWeek') {
            truncatedTitle = truncateText(arg.event.title, 50);
            content += 'fc-event-' + (compareEventType(arg.event) ? 'teams' : 'nota');
            content += '">'; // Fecha a declaração da classe
            content += '<img src="img/' + icon + '" alt="Ícone">';
            content += '<span class="fc-title">' + truncatedTitle + ' - </span>';
            content += '<span class="fc-author">' + arg.event.extendedProps.author + '; </span>';
            content += '<span class="fc-type">Reunião Microsoft Teams</span>';
          }
          content += '</div>';

          return { html: content };
        },
        events: {
          url: 'consultaEventos.php',
          method: 'GET',
          extraParams: {},
          failure: function () {
            alert('Erro ao obter eventos do Office 365.');
          }
        },
        // Atualiza o título da guia Semana com o mês por extenso
        viewDidMount: function (arg) {
          const toolbarTitle = document.querySelector('.fc-toolbar-title');
          let month;
          if (arg.view.type === 'timeGridWeek' || arg.view.type === 'listWeek') {
            month = arg.view.title.toLocaleString('default', { month: 'long' });
          } else {
            month = arg.view.title.toLocaleString('default', { month: 'long' });
          }
          toolbarTitle.textContent = month;

          // Remove o atributo 'title' dos botões
          $('.fc-today-button, .fc-prev-button, .fc-next-button, .fc-month-button, .fc-week-button, .fc-day-button, .fc-list-button').removeAttr('title');
        }
      });

      calendar.render();

      // Função para formatar a data no formato "HH:MM"
      function formatDate(date) {
        const localDate = new Date(date);
        return localDate.toLocaleString('pt-BR', { hour: '2-digit', minute: '2-digit', timeZone: 'America/Sao_Paulo' });
      }

      // Função para truncar o texto se exceder o limite de caracteres
      function truncateText(text, maxLength) {
        if (text.length > maxLength) {
          let truncated = text.substring(0, maxLength);
          let lastSpaceIndex = truncated.lastIndexOf(' ');
          if (lastSpaceIndex !== -1) {
            truncated = truncated.substring(0, lastSpaceIndex);
          }
          return truncated + '...';
        } else {
          return text;
        }
      }

      // Função para formatar a data e hora no formato "dd de MMMM de yyyy"
      function formatDateExtended(date) {
        const options = { day: '2-digit', month: 'long', year: 'numeric' };
        return new Date(date).toLocaleDateString('pt-BR', options).replace(/\b\w/g, l => l.toUpperCase());
      }

      // Função para formatar o horário no formato "HH:MM"
      function formatTime(time) {
        const date = new Date(time);
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        return `${hours}:${minutes}`;
      }

      // Função para formatar a data e hora no formato "dd de MMMM de yyyy, HH:MM"
      function formatDateTime(date) {
        return formatDateExtended(date) + ', ' + formatTime(date);
      }

      // Função para obter o dia do mês
      function getDayOfMonth() {
        const currentDate = new Date();
        return currentDate.getDate();
      }

      // Função para obter o mês atual
      function getCurrentMonth() {
        const currentDate = new Date();
        const monthFormat = new Intl.DateTimeFormat('pt-BR', { month: 'long' });
        const month = monthFormat.formatToParts(currentDate).find(part => part.type === 'month').value;
        return month;
      }

      // Função para obter o ano atual
      function getCurrentYear() {
        const currentDate = new Date();
        const year = currentDate.getFullYear();
        return year;
      }

      // Função para formatar o intervalo de tempo do evento
      function formatEventTimeRange(startTime, endTime) {
        const start = formatTime(startTime);
        const end = formatTime(endTime);
        return `${start} a ${end}`;
      }

      // Função para obter o conteúdo do tooltip do evento
      function getEventTooltip(event) {
        const startDate = formatDateTime(event.start);
        const endDate = formatDateTime(event.end);
        const dayOfMonth = getDayOfMonth();
        const currentMonth = getCurrentMonth();
        const currentYear = getCurrentYear();
        const eventTimeRange = formatEventTimeRange(event.start, event.end);

        return event.title + '<br>' +
          'Reunião Microsoft Teams<br>' +
          dayOfMonth + " de " + currentMonth + ' de ' + currentYear + ", " +
          eventTimeRange;
      }

      // Função para exibir uma janela modal com o conteúdo fornecido
      function showModal(content) {
        const modal = document.createElement('div');
        modal.classList.add('modal');
        modal.innerHTML = content;

        const closeButton = document.createElement('button');
        closeButton.textContent = 'Fechar';
        closeButton.addEventListener('click', function () {
          modal.remove();
        });

        modal.appendChild(closeButton);
        document.body.appendChild(modal);
      }
    });
  </script>

</body>

</html>